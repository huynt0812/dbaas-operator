apiVersion: dbaas.io/v1
kind: DatabaseCluster
metadata:
  name: postgresql-demo
  namespace: default
spec:
  # Engine configuration
  engine:
    type: postgresql
    version: "16.0"

  # Cluster size (number of instances)
  clusterSize: 3

  # Storage configuration
  storage:
    size: 10Gi
    storageClassName: standard

  # Resource requirements
  resources:
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "2"
      memory: 4Gi

  # Backup configuration
  backup:
    enabled: true
    schedule: "0 2 * * *"  # Daily at 2 AM
    retentionPolicy: "7d"

  # Monitoring configuration
  monitoring:
    enabled: true
    pmm:
      serverHost: pmm.example.com
      serverUser: admin

  # Pod scheduling policy
  podSchedulingPolicy:
    nodeSelector:
      workload: database
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  dbaas.io/cluster: postgresql-demo
              topologyKey: kubernetes.io/hostname

  # PostgreSQL-specific configuration
  config:
    - name: max_connections
      value: "200"
    - name: shared_buffers
      value: "1GB"
    - name: effective_cache_size
      value: "3GB"
    - name: maintenance_work_mem
      value: "256MB"
    - name: checkpoint_completion_target
      value: "0.9"
    - name: wal_buffers
      value: "16MB"
    - name: default_statistics_target
      value: "100"
    - name: random_page_cost
      value: "1.1"
    - name: effective_io_concurrency
      value: "200"
    - name: work_mem
      value: "5242kB"
    - name: min_wal_size
      value: "1GB"
    - name: max_wal_size
      value: "4GB"
